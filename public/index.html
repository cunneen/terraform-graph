<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Terraform graph</title>
  </head>
  <body>
    <div style="display: flex">
      <ul style="min-width: 300px"></ul>
      <table style="min-width: 300px; flex: 1">
        <thead>
          <th>Property</th>
          <th>Old value</th>
          <th>New value</th>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <script>
      const colors = {
        'create-delete': 'blue',
        create: 'green',
        update: 'yellow',
        delete: 'red',
        'delete-create': 'orange',
      }

      const ul = document.querySelector('ul')
      const tbody = document.querySelector('tbody')

      function diff(changes) {
        tbody.innerHTML = ''

        for (const { key, action, before, after } of changes) {
          const tr = document.createElement('tr')
          tbody.append(tr)

          let td = document.createElement('td')
          td.style.color = colors[action]
          td.style.verticalAlign = 'top'
          td.innerText = key
          tr.append(td)

          let pre = document.createElement('pre')
          pre.style.whiteSpace = 'pre-wrap'
          pre.style.wordWrap = 'break-word'
          pre.style.margin = 0
          pre.innerText = before
          td = document.createElement('td')
          td.style.maxWidth = '500px'
          td.style.verticalAlign = 'top'
          td.append(pre)
          tr.append(td)

          pre = document.createElement('pre')
          pre.style.whiteSpace = 'pre-wrap'
          pre.style.wordWrap = 'break-word'
          pre.style.margin = 0
          pre.innerText = after
          td = document.createElement('td')
          td.style.maxWidth = '500px'
          td.style.verticalAlign = 'top'
          td.append(pre)
          tr.append(td)
        }
      }

      function appendChild(parent, tree) {
        const li = document.createElement('li')
        if (tree.diff) {
          li.style.color = colors[tree.diff.action]
          const button = document.createElement('button')
          button.innerText = tree.label
          button.addEventListener('click', () => {
            diff(tree.diff.changes)
          })
          li.appendChild(button)
        } else {
          li.innerText = tree.label
        }
        const children = Object.values(tree.children)
        if (children.length) {
          const ul = document.createElement('ul')
          li.appendChild(ul)
          for (const child of children) {
            appendChild(ul, child)
          }
        }
        parent.appendChild(li)
      }

      window.addEventListener('message', (event) => {
        appendChild(ul, JSON.parse(event.data))
      })

      if (window.acquireVsCodeApi) {
        const vscode = window.acquireVsCodeApi()
        const state = vscode.getState()
        if (state) {
          appendChild(ul, JSON.parse(state.text))
        }
      }
    </script>
  </body>
</html>
